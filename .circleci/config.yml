version: 2.1

orbs:
  # The Node.js orb contains a set of prepackaged CircleCI configuration you can utilize
  # Orbs reduce the amount of configuration required for common tasks. 
  # See the orb documentation here: https://circleci.com/developer/orbs/orb/circleci/node
  node: circleci/node@4.1
  gcp-cli: circleci/gcp-cli@2.1.0


jobs:
  # Below is the definition of your job to build and test your app, you can rename and customize it as you want.
  install:  
    # These next lines define a docker executor: https://circleci.com/docs/2.0/executor-types/
    # You can specify an image from Dockerhub or use one of our Convenience Images from CircleCI's Developer Hub.
    # A list of available CircleCI docker Convenience Images are available here: https://circleci.com/developer/images/image/cimg/node
    docker:
      - image: circleci/node:latest
    steps:
      # Checkout the code as the first step.
      - checkout
      - run:
          name: install cloud sdk
          command: |
            sudo apt-get -y install apt-transport-https ca-certificates gnupg
            echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
            curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
            sudo apt-get update && sudo apt-get -y install google-cloud-sdk
      - run:
          name: authorize gcloud sdk
          command: | 
            echo $GCLOUD_KEY | gcloud auth activate-service-account build-953@arboreal-parser-294008.iam.gserviceaccount.com --key-file=-
            gcloud --quiet config set project ${GOOGLE_PROJECT_ID}
            gcloud --quiet config set compute/zone ${GOOGLE_COMPUTE_ZONE}
      - run:
          name: Run cloud builds
          command: gcloud builds submit --config cloudbuild.yaml .
      - run:
          name: canary update
          command: gcloud compute instance-groups managed rolling-action start-update dateapi-group \
    --version=template=dateapi-backend \
    --canary-version=template=dateapi-backend,target-size=20

workflows:
  version: 2.1
  workflow:
    jobs:
    - install:
        filters:
          branches:
            only: circleci-project-setup

  # Below is the definition of your workflow.
  # Inside the workflow, you provide the jobs you want to run, e.g this workflow runs the build-and-test job above.
  # CircleCI will run this workflow on every commit.
  # For more details on extending your workflow, see the configuration docs: https://circleci.com/docs/2.0/configuration-reference/#workflows
  #  install_and_configure_cli:
  #  jobs:
  #    - gcp-cli/install_and_initialize_cli:
  #        context: 
  #        executor:
          #sample: 
          #jobs:
          #- build-and-test
      # For running simple node tests, you could optionally use the node/test job from the orb to replicate and replace the job above in fewer lines.
      # - node/test
